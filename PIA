# Verificar si PowerShell se ejecuta como Administrador
function Test-Administrator {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    $adminRole = [Security.Principal.WindowsBuiltInRole]::Administrator
    if (-not $principal.IsInRole($adminRole)) {
        Write-Error "Este script debe ejecutarse como Administrador. Ejecuta PowerShell como Administrador e inténtalo de nuevo."
        exit 1
    }
}

# Verificar conexión a Internet
function Test-InternetConnection {
    try {
        $url = "https://www.google.com"
        $request = [System.Net.WebRequest]::Create($url)
        $request.Timeout = 5000
        $response = $request.GetResponse()
        $response.Close()
        Write-Host "Conexión a Internet detectada"
    } catch {
        Write-Error "No hay conexión a Internet. Por favor, verifica tu conexión y vuelve a intentarlo."
        exit 1
    }
}

# Verificar y actualizar versión de PowerShell
function Update-PowerShell {
    $currentVersion = $PSVersionTable.PSVersion
    if ($currentVersion.Major -lt 7) {
        Write-Host "Actualizando PowerShell a la versión 7 o superior..."
        $installerUrl = "https://aka.ms/win32-x64/powershell-7.4.0-win-x64.msi" # Cambia a la versión que deseas
        $outputPath = "$env:TEMP\PowerShell-Installer.msi"

        # Descargar el instalador
        Invoke-WebRequest -Uri $installerUrl -OutFile $outputPath

        # Instalar PowerShell de manera silenciosa
        Start-Process -FilePath msiexec.exe -ArgumentList "/i `"$outputPath`" /quiet /norestart" -Wait
        
        # Limpiar el archivo de instalación
        Remove-Item $outputPath -Force
    } else {
        Write-Host "La versión de PowerShell está actualizada: $currentVersion"
    }
}

# Instalar .NET Framework 3.5
function Install-DotNet35 {
    try {
        # Habilitar .NET Framework 3.5 sin instalación silenciosa
        Write-Host "Instalando .NET Framework 3.5..."
        Start-Process -FilePath "DISM" -ArgumentList "/Online", "/Enable-Feature", "/FeatureName:NetFx3", "/All" -Wait
        Write-Host ".NET Framework 3.5 se ha instalado correctamente."
    } catch {
        Write-Error "Error al instalar .NET Framework 3.5: $_"
    }
}

# Instalar o actualizar Chocolatey
function Install-Update-Chocolatey {
    if (!(Get-Command choco.exe -ErrorAction SilentlyContinue)) {
        Write-Host "Instalando Chocolatey..."
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
        Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
    } else {
        Write-Host "Chocolatey ya está instalado. Actualizando..."
        choco upgrade chocolatey -y
    }
}

# Instalar o actualizar programas con Chocolatey
function Install-Programs {
    $programs = @(
        "winrar",
        "7zip",
        "googlechrome",
        "anydesk",
        "crystaldiskinfo",
        "hwinfo",
        "hwmonitor",
        "malwarebytes",
        "sumatrapdf",              
        "bulk-crap-uninstaller",    
        "vlc",
        "driverbooster"             
    )

    foreach ($program in $programs) {
        try {
            $installedPackage = choco list --local-only | Select-String $program
            if ($installedPackage) {
                Write-Host "$program ya está instalado, verificando actualizaciones..."
                choco upgrade $program -y
            } else {
                Write-Host "Instalando $program..."
                choco install $program -y
            }
        } catch {
            $errorMessage = $_.Exception.Message  # Se obtiene el mensaje de la excepción
            Write-Error "Error al instalar/actualizar ${program}: ${errorMessage}"  # Uso correcto de la variable
        }
    }
}

# Actualizar Microsoft Store o repararlo si es necesario
function Repair-Update-MicrosoftStore {
    $storePackage = Get-AppxPackage -AllUsers Microsoft.WindowsStore -ErrorAction SilentlyContinue
    if ($storePackage) {
        Write-Host "Microsoft Store encontrado, reparando y actualizando..."
        foreach ($package in $storePackage) {
            Add-AppxPackage -DisableDevelopmentMode -Register "$($package.InstallLocation)\AppxManifest.xml"
        }
    } else {
        Write-Host "Microsoft Store no encontrado, omitiendo..."
    }
}

# Ejecutar todas las funciones en orden
Test-Administrator
Test-InternetConnection
Update-PowerShell
Install-Update-Chocolatey
Install-DotNet35  # Llamada a la función para instalar .NET Framework 3.5 sin modo silencioso
Install-Programs
Repair-Update-MicrosoftStore

Write-Host "Todas las tareas han sido completadas con éxito."
